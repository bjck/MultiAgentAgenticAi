# AGENTS.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

Multi-agent AI orchestration system built with Spring Boot 3.5 and Spring AI 1.1. The application decomposes user requests into parallel tasks, assigns them to specialized worker agents, and synthesizes results into a unified response. Uses Google Gemini (gemini-2.5-flash) as the LLM backend and MCP (Model Context Protocol) for filesystem tool access.

## Build & Run Commands

```powershell
# Build (skip tests)
mvn clean package -DskipTests

# Run tests
mvn test

# Run single test class
mvn test -Dtest=ClassName

# Run application (requires GOOGLE_API_KEY env var)
mvn spring-boot:run

# Run the packaged JAR
java -jar target\MultiAgent-0.0.1-SNAPSHOT.jar
```

## Required Environment Variables

- `GOOGLE_API_KEY` - Google AI API key for Gemini access
- `WORKSPACE_ROOT` (optional) - Root directory for file operations, defaults to current directory
- `MCP_FS_*` (optional) - Override MCP filesystem server command/args for non-Windows platforms
- `LIQUIBASE_ENABLED` (optional) - Set to `true` to enable database migrations and persistence (default: `false`)
- `SPRING_DATASOURCE_URL` (optional) - JDBC URL for PostgreSQL (e.g., `jdbc:postgresql://localhost:5432/multiagent`)
- `SPRING_DATASOURCE_USERNAME` (optional) - Database username
- `SPRING_DATASOURCE_PASSWORD` (optional) - Database password

## Architecture

### Orchestration Flow (OrchestratorService)

1. **Planning**: Orchestrator agent analyzes user request and creates an `OrchestratorPlan` with up to `maxTasks` independent `TaskSpec` entries
2. **Parallel Execution**: Worker agents execute tasks concurrently (controlled by `workerConcurrency`), each assigned a role from the configured `workerRoles`
3. **Synthesis**: If multiple workers were used, a synthesis agent combines outputs into a coherent response

### Key Components

- `OrchestratorService` - Core orchestration logic with three-phase workflow (plan → execute → synthesize)
- `MultiAgentProperties` - Configuration via `multiagent.*` prefix in application.yml
- `FileService` - Workspace-scoped file operations with path traversal protection
- `OrchestrationPersistenceService` - Handles saving sessions, prompts, plans, and results to the database
- `ChatController` - REST endpoints:
  - `POST /api/chat` - Full orchestration (plan + execute + synthesize)
  - `POST /api/chat/plan` - Preview plan only without execution
- `FileController` (`/api/files`) - File listing/read/write endpoints
- `JPA Entities` (`com.bko.entity`) - Data models for Agent roles, Skills, Tools, and Orchestration logs
- `Repositories` (`com.bko.repository`) - Spring Data JPA repositories for database access

### Worker Roles

Configurable via `multiagent.worker-roles`: research, design, engineering, qa, writing, general

### MCP Integration

The application integrates with MCP filesystem server to give agents file access within the workspace. On Windows, it uses `cmd.exe /c npx -y @modelcontextprotocol/server-filesystem`. Override via `MCP_FS_*` env vars for other platforms.

## Database & Persistence

The system uses PostgreSQL for persisting agent configurations and logging orchestration sessions.

### Local PostgreSQL with Docker Compose

A `docker-compose.yml` is provided at the root to quickly start a database.

```powershell
# Start Postgres in background
docker compose up -d

# Stop and remove
docker compose down
```

### Persistence Schema

The database schema is managed via Liquibase (`src/main/resources/db/changelog`).

1. **Agent Configuration**:
   - `agent_role`: Defines orchestrator, synthesis, and worker roles with their metadata.
   - `skill`: Shared catalog of agent skills.
   - `role_skill`: Maps skills to specific agent roles.
   - `tool`: Shared catalog of MCP tools.
   - `role_tool_policy`: Defines tool permissions (ALLOW/DENY) per role.

2. **Orchestration Logging**:
   - `orchestration_session`: Stores the top-level session (user prompt, model, final answer).
   - `prompt_log`: Every LLM request and response, including system/user prompts and model parameters.
   - `orchestrator_plan_log`: Versions of plans generated by the orchestrator.
   - `task_log`: Individual tasks within a plan.
   - `worker_result_log`: Outputs from worker agents linked to their sessions and tasks.

### Running Migrations

Database migrations run automatically on application startup if `LIQUIBASE_ENABLED=true`.

Alternatively, you can run migrations independently using the **Liquibase Maven Plugin**. A `liquibase.properties` file is provided in the project root with default connection details for the local Docker environment.

```powershell
# Check status
mvn liquibase:status

# Apply migrations
mvn liquibase:update

# Rollback last change (example)
mvn liquibase:rollback -Dliquibase.rollbackCount=1
```

If you need to use different credentials, you can either edit `liquibase.properties` or override them on the command line:

```powershell
mvn liquibase:update -Dliquibase.url="jdbc:postgresql://your-host:5432/db" -Dliquibase.username="user" -Dliquibase.password="pass"
```

### Enabling Persistence

Persistence is transparently integrated into `OrchestratorService`. To enable it, set `LIQUIBASE_ENABLED=true` and provide datasource credentials via environment variables.

## Configuration Defaults

```yaml
multiagent:
  max-tasks: 4           # Maximum parallel tasks per request
  worker-concurrency: 4  # Thread pool size for workers
  worker-timeout: 90s    # Per-worker timeout
```

## Agent Tools Configuration

You can restrict which function/tools are attached to each agent phase/role to reduce token usage and enforce least-privilege. Only the selected tools are exposed to the LLM for that call.

Configuration keys:

```yaml
multiagent:
  tools:
    orchestrator: []           # Tools for planning/role selection (default: none)
    synthesis: []              # Tools for final synthesis (default: none)
    worker-defaults:           # Default tools for all worker roles
      - list_directory
      - read_file
    workers:                   # Per-role overrides
      analysis:
        - list_directory
        - read_file            # Read-only; no write access
      engineering:
        - list_directory
        - read_file
        - write_file           # Write allowed only for engineering by default
      qa:
        - list_directory
        - read_file
      research:
        - list_directory
        - read_file
      design:
        - list_directory
        - read_file
      writing:
        - list_directory
        - read_file
      general:
        - list_directory
        - read_file
```

Notes:
- Orchestrator and Synthesis phases do not need write access, so they default to no tools.
- Analysis is read-only by default (no write access).
- Engineering is the only role with write access by default.
- You can change tool exposure at runtime via application.yml (no code changes required).

## Agent Skills Configuration

Skills can be assigned to agents to provide specialized instructions and capabilities. Each skill has a name, description, and instructions that are included in the agent's system prompt.

### Configuration Structure

```yaml
multiagent:
  skills:
    # Skills for the orchestrator agent (planning phase)
    orchestrator:
      - name: "Domain Expert"
        description: "Expertise in specific domain"
        instructions: "Apply domain knowledge when planning tasks"
    
    # Skills for the synthesis agent (combining worker outputs)
    synthesis:
      - name: "Report Writer"
        description: "Expert at writing reports"
        instructions: "Format output as a structured report"
    
    # Default skills applied to all worker agents
    worker-defaults:
      - name: "Best Practices"
        description: "Follow coding best practices"
        instructions: "Always follow SOLID principles"
    
    # Role-specific skills for worker agents
    workers:
      engineering:
        - name: "Java Expert"
          description: "Expertise in Java development"
          instructions: "Use modern Java features and patterns"
      research:
        - name: "Academic Research"
          description: "Academic research methodology"
          instructions: "Cite sources and use proper methodology"
```

### Skill Properties

- `name` - Short identifier for the skill
- `description` - Brief explanation of what the skill provides
- `instructions` - Detailed instructions to guide the agent's behavior
